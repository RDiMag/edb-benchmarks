---
- hosts: pgsql1.AWS-Cluster-default.internal
  name: Process pgbench results
  become: false

  tasks:
    - name: Fetch pgbench data files
      ansible.builtin.fetch:
        src: "/tmp/pgbench-tps-{{ pg_version }}.csv"
        dest: "{{ results_directory }}/pgbench_data/\
              pgbench-tps-{{ pg_version }}.csv"
        flat: true
      ignore_errors: true

    - name: Generate final data points and chart
      local_action:
        module: ansible.builtin.shell
        cmd: |
          cp {{ playbook_dir }}/post-processing {{ results_directory }}
          {{ results_directory }}/post-processing
      ignore_errors: true

    - name: Copy data to results directory
      local_action:
        module: ansible.builtin.copy
        src: "{{ results_directory }}/pgbench_data/"
        dest: "{{ results_directory }}/"
      ignore_errors: true
